<!doctype html>
<html>
<head><meta charset="utf-8"></head>
<body>
<script>
async function run() {

  const now = new Date();
  now.setMinutes(0,0,0);
  const end = new Date(now.getTime() + 36*60*60*1000);

  function fmt(d){ return d.toISOString().slice(0,16); }

  const url =
    `https://api.energidataservice.dk/dataset/DayAheadPrices` +
    `?start=${fmt(now)}&end=${fmt(end)}` +
    `&filter=${encodeURIComponent('{"PriceArea":["DK1","DK2"]}')}` +
    `&limit=500`;

  const res = await fetch(url);
  const json = await res.json();

  const times = {};

  json.records.forEach(r => {
    const d = new Date(r.TimeDK);
    d.setMinutes(0,0,0);
    const key = d.toISOString().slice(0,13)+":00";

    if (!times[key]) times[key] = { DK1: [], DK2: [] };
    times[key][r.PriceArea].push(r.DayAheadPriceDKK);
  });

  let csv = "time,jylland_fyn,sjaelland_oerne\n";

  Object.keys(times).sort().forEach(hour => {
    const jf = times[hour].DK1.reduce((a,b)=>a+b,0)/times[hour].DK1.length;
    const oe = times[hour].DK2.reduce((a,b)=>a+b,0)/times[hour].DK2.length;
    csv += `${hour},${jf},${oe}\n`;
  });

  const blob = new Blob([csv], {type:"text/plain"});
  const reader = new FileReader();
  reader.onload = () => { document.body.innerText = reader.result; };
  reader.readAsText(blob);

}
run();
</script>
</body>
</html>
